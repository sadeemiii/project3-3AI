<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لعبة الروبوت والكرة</title>
<style>
body {
  background: radial-gradient(circle at center, #0a0a1f, #000);
  font-family: 'Cairo', sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#maze {
  width: 80vw;
  max-width: 600px;
  height: 80vw;
  max-height: 600px;
  position: relative;
  background: #1c1c2e;
  border: 4px solid #00bcd4;
  margin-top: 20px;
  overflow: hidden;
}
#pathCanvas {
  position: absolute;
  top:0; left:0;
  width: 100%;
  height: 100%;
  z-index: 1;
}
#robot, #ball {
  position: absolute;
  z-index: 2;
}
#ball {
  position: absolute;
  width: 3%;      /* نسبة من عرض المتاهة */
  height: 3%;     /* نسبة من ارتفاع المتاهة */
  border-radius: 50%;
  background: radial-gradient(circle, #ffeb3b, #f57f17);
  cursor: grab;
  touch-action: none;
}
#robot {
  width: 3%;
  height: 3%;
  border-radius: 10%;
  background: radial-gradient(circle, #00e5ff, #007c91);
}
.wall {
  position: absolute;
  background: #444;
  border-radius: 5px;
}
.sections {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}
.section-btn {
  padding: 10px 20px;
  margin: 0 5px;
  border-radius: 12px;
  background: #00aaff;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 16px;
}
.section-btn:hover { background: #005dc1; transform: scale(1.05); }
.section-btn:active { background: #ff8e0c; }

@media(max-width:700px){
  #ball, #robot { width:4%; height:4%; }
}
@media(max-width:480px){
  #ball, #robot { width:4%; height:4%; }
} 

</style>
</head>
<body>

<div id="maze">
  <canvas id="pathCanvas"></canvas>
  <div id="robot" style="top:5%; left:5%;"></div>
  <div id="ball" style="top:85%; left:85%;"></div>

  <!-- أمثلة الحواجز -->
  <div class="wall" style="top:12.5%; left:0; width:75%; height:2.5%;"></div>
  <div class="wall" style="top:25%; left:50%; width:50%; height:2.5%;"></div>
  <div class="wall" style="top:37.5%; left:0; width:62.5%; height:2.5%;"></div>
  <div class="wall" style="top:50%; left:43.5%; width:50%; height:2.5%;"></div>
  <div class="wall" style="top:62.5%; left:0; width:75%; height:2.5%;"></div>
  <div class="wall" style="top:18.5%; left:87.5%; width:2.5%; height:75%;"></div>
  <div class="wall" style="top:6.25%; left:12.5%; width:2.5%; height:37.5%;"></div>
  <div class="wall" style="top:43.5%; left:18.5%; width:2.5%; height:50%;"></div>
</div>

<div class="sections">
  <button id="manualBtn" class="section-btn">بدء المطاردة</button>
  <a href="index.html" class="section-btn">الرئيسية</a>
</div>

<script>
window.onload = () => {
const robot = document.getElementById("robot");
const ball = document.getElementById("ball");
const maze = document.getElementById("maze");
const walls = document.querySelectorAll(".wall");
const canvas = document.getElementById("pathCanvas");
const ctx = canvas.getContext("2d");
let robotPos = {x:robot.offsetLeft, y:robot.offsetTop};
let ballPos = {x:ball.offsetLeft, y:ball.offsetTop};
let chasing = false;

// السحب بالماوس واللمس
function enableDrag(elem){
  elem.addEventListener("mousedown", startDrag);
  elem.addEventListener("touchstart", startTouch,{passive:false});

  function startDrag(e){
    e.preventDefault();
    const shiftX = e.clientX - elem.getBoundingClientRect().left;
    const shiftY = e.clientY - elem.getBoundingClientRect().top;
    function moveAt(pageX,pageY){
      let x = pageX - maze.getBoundingClientRect().left - shiftX;
      let y = pageY - maze.getBoundingClientRect().top - shiftY;
      x = Math.max(0, Math.min(maze.clientWidth - elem.offsetWidth, x));
      y = Math.max(0, Math.min(maze.clientHeight - elem.offsetHeight, y));
      if(!checkCollisionRect(x,y,elem.offsetWidth,elem.offsetHeight)){
        elem.style.left = x+"px";
        elem.style.top = y+"px";
        if(elem.id==="ball") ballPos={x,y};
      }
    }
    function onMouseMove(e){ moveAt(e.pageX,e.pageY); }
    function onMouseUp(){ document.removeEventListener("mousemove",onMouseMove); document.removeEventListener("mouseup",onMouseUp); }
    document.addEventListener("mousemove",onMouseMove);
    document.addEventListener("mouseup",onMouseUp);
  }

  function startTouch(e){
    e.preventDefault();
    const touch = e.touches[0];
    const shiftX = touch.clientX - elem.getBoundingClientRect().left;
    const shiftY = touch.clientY - elem.getBoundingClientRect().top;

    function moveAt(touchX, touchY){
      let x = touchX - maze.getBoundingClientRect().left - shiftX;
      let y = touchY - maze.getBoundingClientRect().top - shiftY;
      x = Math.max(0, Math.min(maze.clientWidth - elem.offsetWidth, x));
      y = Math.max(0, Math.min(maze.clientHeight - elem.offsetHeight, y));
      if(!checkCollisionRect(x,y,elem.offsetWidth,elem.offsetHeight)){
        elem.style.left = x + "px";
        elem.style.top = y + "px";
        if(elem.id==="ball") ballPos={x,y};
      }
    }

    function onTouchMove(e){ 
      e.preventDefault();
      moveAt(e.touches[0].clientX, e.touches[0].clientY);
    }

    function onTouchEnd(){
      document.removeEventListener("touchmove", onTouchMove);
      document.removeEventListener("touchend", onTouchEnd);
    }

    document.addEventListener("touchmove", onTouchMove, {passive:false});
    document.addEventListener("touchend", onTouchEnd);
  }
}
enableDrag(ball);

// كشف التصادم
function checkCollisionRect(x,y,w,h){
  const rect={left:x,top:y,right:x+w,bottom:y+h};
  for(const wall of walls){
    const r = wall.getBoundingClientRect();
    const m = maze.getBoundingClientRect();
    const wallRect = {left:r.left-m.left, top:r.top-m.top, right:r.right-m.left, bottom:r.bottom-m.top};
    if(rect.left<wallRect.right && rect.right>wallRect.left &&
       rect.top<wallRect.bottom && rect.bottom>wallRect.top) return true;
  }
  return false;
}

// الشبكة
const cols=40, rows=40;
let grid=Array(rows).fill().map(()=>Array(cols).fill(0));

function updateGrid(){
  grid = Array(rows).fill().map(()=>Array(cols).fill(0));
  walls.forEach(w=>{
    const r = w.getBoundingClientRect();
    const m = maze.getBoundingClientRect();
    const startCol = Math.floor((r.left-m.left)/(maze.clientWidth/cols));
    const startRow = Math.floor((r.top-m.top)/(maze.clientHeight/rows));
    const wCols = Math.ceil(r.width/(maze.clientWidth/cols));
    const wRows = Math.ceil(r.height/(maze.clientHeight/rows));
    for(let i=startRow; i<startRow+wRows; i++)
      for(let j=startCol; j<startCol+wCols; j++)
        if(i<rows && j<cols) grid[i][j]=1; // 1 يعني خانة محجوبة
  });
}
updateGrid();

// تحويل الإحداثيات
function posToGrid(pos){ 
  return {
    row: Math.floor(pos.y / (maze.clientHeight/rows)),
    col: Math.floor(pos.x / (maze.clientWidth/cols))
  }; 
}
function gridToPos(cell){ 
  return {
    x: cell.col*(maze.clientWidth/cols) + (maze.clientWidth/cols)/2 - robot.offsetWidth/2,
    y: cell.row*(maze.clientHeight/rows) + (maze.clientHeight/rows)/2 - robot.offsetHeight/2
  }; 
}

// BFS لإيجاد المسار
function findPath(start,end){
  let queue=[start];
  let visited=Array(rows).fill().map(()=>Array(cols).fill(false));
  let prev=Array(rows).fill().map(()=>Array(cols).fill(null));
  visited[start.row][start.col]=true;
  const dirs=[[0,1],[1,0],[0,-1],[-1,0]];
  while(queue.length){
    const cur=queue.shift();
    if(cur.row===end.row && cur.col===end.col) break;
    for(const [dr,dc] of dirs){
  const nr = cur.row + dr, nc = cur.col + dc;
  if(nr>=0 && nr<rows && nc>=0 && nc<cols && !visited[nr][nc] && grid[nr][nc]==0){
    visited[nr][nc] = true;
    prev[nr][nc] = cur;
    queue.push({row:nr,col:nc});
  }
}
  }
  let path=[];
  let cur=end;
  while(cur){ path.push(cur); cur=prev[cur.row][cur.col]; }
  path.reverse();
  return path;
}

// رسم المسار الأسود متناسب
function drawPath(path){
  // ضبط حجم الـ canvas ليكون مطابق للمتاهة
  canvas.width = maze.clientWidth;
  canvas.height = maze.clientHeight;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='black';
  ctx.lineWidth = Math.max(4, maze.clientWidth/150);
  ctx.beginPath();
  path.forEach((p,i)=>{
    const pos = gridToPos(p);
    if(i===0) ctx.moveTo(pos.x + robot.offsetWidth/2, pos.y + robot.offsetHeight/2);
    else ctx.lineTo(pos.x + robot.offsetWidth/2, pos.y + robot.offsetHeight/2);
  });
  ctx.stroke();
}

// حركة الروبوت خطوة خطوة
const stepDelay = 80;
function moveAlongPath(path,index=0){
  if(index>=path.length){ 
    chasing=false; 
    robot.style.background="radial-gradient(circle,#76ff03,#2e7d32)";
    return; 
  }
  const pos = gridToPos(path[index]);
  robot.style.left = pos.x+"px";
  robot.style.top = pos.y+"px";
  robotPos.x = pos.x;
  robotPos.y = pos.y;
  setTimeout(()=>moveAlongPath(path,index+1), stepDelay);
}

// زر بدء المطاردة
document.getElementById("manualBtn").addEventListener("click", ()=>{
  if(!chasing){
    updateGrid();
    chasing=true;
    robot.style.background="radial-gradient(circle,#00e5ff,#007c91)";
    const start=posToGrid(robotPos);
    const end=posToGrid(ballPos);
    const path=findPath(start,end);
    if(path.length<=1){ 
      alert("لا يمكن الوصول إلى الكرة!"); 
      chasing=false; 
      return;
    }
    drawPath(path);
    moveAlongPath(path);
  }
});
};
</script>
</body>
</html>